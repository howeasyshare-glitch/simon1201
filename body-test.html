<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Body Shape Â· èº«æé…ä»¶å®Œæˆç‰ˆ + å•†å“æœå°‹æ¸¬è©¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --primary: #222;
      --accent: #ff6b6b;
      --muted: #777;
      --border-radius-lg: 18px;
      --border-radius-sm: 10px;
      --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #ffecec 0, #f5f5f7 45%, #f5f5f7 100%);
      color: var(--primary);
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header { margin-bottom: 20px; }

    .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 22px;
      font-weight: 700;
    }

    .logo-pill {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ff6b6b, #ff9f43);
      box-shadow: 0 6px 15px rgba(255, 107, 107, 0.5);
    }

    .subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 20px;
    }

    @media (max-width: 840px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 20px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #f3f3f8;
      color: var(--muted);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 14px;
      margin-bottom: 14px;
    }

    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    label { font-weight: 500; }

    .hint {
      font-size: 11px;
      color: var(--muted);
    }

    select,
    input[type="number"] {
      padding: 8px 10px;
      border-radius: var(--border-radius-sm);
      border: 1px solid #e0e0ea;
      background: #fafafa;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    select:focus,
    input[type="number"]:focus {
      border-color: #ff8a8a;
      box-shadow: 0 0 0 2px rgba(255, 138, 138, 0.35);
      background: #ffffff;
    }

    .checkbox-row {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .checkbox-row label {
      font-weight: 400;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .checkbox-row input[type="checkbox"] {
      transform: scale(0.9);
    }

    .primary-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #ff6b6b, #ff9f43);
      color: #fff;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(255, 107, 107, 0.5);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;
    }

    .primary-btn:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(255, 107, 107, 0.6);
      opacity: 0.95;
    }

    .primary-btn[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .btn-row {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .status-text {
      font-size: 11px;
      color: var(--muted);
    }

    .status-text.loading::before { content: "â³ "; }
    .status-text.done::before    { content: "âœ¨ "; }
    .status-text.error::before   { content: "âš ï¸ "; }

    .image-wrapper {
      border-radius: var(--border-radius-lg);
      background: linear-gradient(125deg, #fff7f7, #f9fbff);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .image-inner {
      flex: 1;
      border-radius: 16px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 1px solid #f0f0f5;
      aspect-ratio: 3 / 4;
    }

    #result-image {
      max-width: 100%;
      max-height: 100%;
      display: block;
      object-fit: contain;
    }

    .image-placeholder {
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      padding: 12px;
    }

    .desc {
      font-size: 13px;
      color: var(--muted);
    }

    footer {
      margin-top: 20px;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .product-card {
      display: grid;
      grid-template-columns: 60px minmax(0, 1fr);
      gap: 8px;
      border-radius: 10px;
      border: 1px solid #eee;
      padding: 6px 8px;
      background: #fafafa;
    }

    .product-thumb {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #999;
    }

    .product-thumb img {
      max-width: 100%;
      max-height: 100%;
    }

    .product-main {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .product-title {
      font-size: 12px;
      font-weight: 500;
    }

    .product-meta {
      font-size: 11px;
      color: #777;
    }

    .product-price {
      font-size: 12px;
      font-weight: 600;
    }

    .product-link {
      font-size: 11px;
      color: #ff7b7b;
      text-decoration: none;
    }

    .product-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title">
        <span class="logo-pill"></span>
        <span>Body Shape Test Â· èº«æé…ä»¶å®Œæˆç‰ˆ + å•†å“æœå°‹æ¸¬è©¦</span>
      </div>
      <div class="subtitle">
        å¾Œç«¯ä½¿ç”¨ã€Œèº«æç‰ˆæœ¬2025 v1ã€ï¼‹é…ä»¶æ§åˆ¶ï¼ˆåŒ…åŒ… / å¸½å­ / å¤–å¥—ï¼‰ã€‚é€™å€‹é é¢å¦å¤–åŠ ä¸Š SerpApi å•†å“æœå°‹ï¼Œè®“ä½ çœ‹åˆ°å¯¦éš›çš„å•†å“åç¨±èˆ‡é€£çµã€‚
      </div>
    </header>

    <main class="layout">
      <!-- å·¦å´ï¼šæ¢ä»¶è¼¸å…¥ -->
      <section class="card">
        <div class="card-title">
          æ¸¬è©¦æ¢ä»¶
          <span class="pill">Step 1 Â· èº«æï¼‹é…ä»¶è¨­å®š</span>
        </div>

        <form id="body-form" onsubmit="event.preventDefault(); generateOutfit();">
          <div class="form-grid">
            <div class="form-field">
              <label for="gender">æ€§åˆ¥</label>
              <select id="gender" required>
                <option value="female">å¥³æ€§</option>
                <option value="male">ç”·æ€§</option>
                <option value="neutral">ä¸­æ€§ / ä¸æ‹˜</option>
              </select>
              <div class="hint">åªå½±éŸ¿äººç‰©å½¢è±¡ï¼Œä¸é™åˆ¶è¡£æœæ¬¾å¼ã€‚</div>
            </div>

            <div class="form-field">
              <label for="age">å¹´é½¡</label>
              <input type="number" id="age" min="10" max="80" value="25" required />
              <div class="hint">ä¾‹å¦‚ï¼š18ã€25ã€35ã€45â€¦</div>
            </div>

            <div class="form-field">
              <label for="height">èº«é«˜ï¼ˆcmï¼‰</label>
              <input type="number" id="height" min="140" max="210" value="165" required />
              <div class="hint">å»ºè­°ä¸€æ¬¡å›ºå®šèº«é«˜ï¼Œåªæ”¹é«”é‡åšæ¯”è¼ƒã€‚</div>
            </div>

            <div class="form-field">
              <label for="weight">é«”é‡ï¼ˆkgï¼‰</label>
              <input type="number" id="weight" min="35" max="150" value="55" required />
              <div class="hint">å¯ä»¥æ¸¬è©¦ 45 / 60 / 80 / 100 kg çš„å·®ç•°ã€‚</div>
            </div>

            <div class="form-field">
              <label for="style">é¢¨æ ¼</label>
              <select id="style">
                <option value="casual">ä¼‘é–’æ—¥å¸¸</option>
                <option value="minimal">æ¥µç°¡é€šå‹¤</option>
                <option value="street">è¡—é ­é¢¨</option>
                <option value="sporty">é‹å‹•é¢¨</option>
                <option value="smart">Smart Casual</option>
              </select>
            </div>

            <div class="form-field">
              <label for="temp">æº«åº¦ï¼ˆÂ°Cï¼‰</label>
              <input type="number" id="temp" value="22" />
              <div class="hint">æœƒå½±éŸ¿è¡£æœåšåº¦ï¼Œèº«æä¸å—å½±éŸ¿ã€‚</div>
            </div>

            <div class="form-field">
              <label>èº«æé ä¼°ï¼ˆBMIï¼‰</label>
              <div id="bmi-info" class="hint">BMIï¼š--ï¼Œèº«å‹ï¼š--</div>
            </div>

            <div class="form-field">
              <label>é…ä»¶é¸æ“‡</label>
              <div class="checkbox-row">
                <label>
                  <input type="checkbox" id="acc-bag" checked />
                  åŒ…åŒ…
                </label>
                <label>
                  <input type="checkbox" id="acc-hat" />
                  å¸½å­
                </label>
                <label>
                  <input type="checkbox" id="acc-coat" />
                  å¤–å¥— / ç½©è¡« / å¤¾å…‹
                </label>
              </div>
              <div class="hint">é€™ä¸‰å€‹æœƒç›´æ¥å½±éŸ¿å¾Œç«¯ promptï¼Œè¦çœ‹æ¨¡å‹æœ‰æ²’æœ‰ä¹–ä¹–ç…§åšã€‚</div>
            </div>
          </div>

          <div class="btn-row">
            <span id="status" class="status-text">è¨­å®šå¥½æ¢ä»¶å¾Œï¼ŒæŒ‰ä¸‹ã€Œç”¢ç”Ÿ AI ç©¿æ­ç¤ºæ„åœ–ã€ã€‚</span>
            <button type="submit" id="generate-btn" class="primary-btn">
              ğŸ§â€â™€ï¸ ç”¢ç”Ÿ AI ç©¿æ­ç¤ºæ„åœ–
            </button>
          </div>
        </form>
      </section>

      <!-- å³å´ï¼šçµæœ -->
      <section class="card">
        <div class="card-title">
          åœ–åƒèˆ‡å•†å“æ¸¬è©¦
          <span class="pill">Step 2 Â· æŸ¥çœ‹ AI åœ–åƒ & å•†å“æœå°‹çµæœ</span>
        </div>

        <div class="image-wrapper">
          <div class="image-inner">
            <img id="result-image" src="" alt="Outfit preview" style="display:none;" />
            <div id="image-placeholder" class="image-placeholder">
              é‚„æ²’æœ‰çµæœã€‚<br />
              å…ˆç”¢ç”Ÿä¸€æ¬¡ AI ç©¿æ­ç¤ºæ„åœ–ï¼Œå†æŒ‰ä¸‹ä¸‹é¢çš„ã€ŒæŠ“é¡ä¼¼å•†å“ã€ã€‚
            </div>
          </div>
          <div class="desc">
            å¾Œç«¯ä½¿ç”¨ã€Œèº«æç‰ˆæœ¬2025 v1ã€ï¼Œå…ˆç•«è²¼èº«ç´ è‰²èº«æåŸºåº•åœ–ï¼Œå†åœ¨åŒä¸€å€‹èº«æä¸Šå¥— UNIQLO é¢¨æ ¼ç©¿æ­ï¼‹é…ä»¶æ¢ä»¶ã€‚
          </div>
        </div>

        <!-- é¡ä¼¼å•†å“æœå°‹çµæœå€å¡Šï¼ˆSerpApi æ¸¬è©¦ï¼‰ -->
        <div style="margin-top: 14px;">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
            <div style="font-size:13px; color:#555; font-weight:500;">
              é¡ä¼¼å•†å“ï¼ˆSerpApi / Google Shopping æ¸¬è©¦ï¼‰
            </div>
            <button
              type="button"
              onclick="searchSimilarProducts()"
              style="
                border:none;
                border-radius:999px;
                padding:4px 10px;
                font-size:11px;
                cursor:pointer;
                background:#f3f3f8;
                color:#555;
              "
            >
              ğŸ” æŠ“é¡ä¼¼å•†å“
            </button>
          </div>
          <div id="product-status" class="desc" style="font-size:11px; margin-bottom:4px;">
            æŒ‰ä¸‹ã€ŒæŠ“é¡ä¼¼å•†å“ã€å¾Œï¼Œæœƒç”¨ç›®å‰æ€§åˆ¥ï¼‹é¢¨æ ¼å»å‘¼å« /api/search-productsã€‚
          </div>
          <div
            id="product-results"
            style="
              display:flex;
              flex-direction:column;
              gap:8px;
              max-height:220px;
              overflow-y:auto;
              padding-right:4px;
              border-top:1px solid #f0f0f5;
              margin-top:4px;
              padding-top:6px;
            "
          >
            <!-- JS æœƒåœ¨é€™è£¡å¡å•†å“å¡ç‰‡ -->
          </div>
        </div>
      </section>
    </main>

    <footer>
      Debug Tipsï¼šå¦‚æœå•†å“å€å¡Šé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œè«‹åŒæ™‚æ‰“é–‹ DevToolsï¼ˆF12ï¼‰çœ‹ Console / Networkã€‚
    </footer>
  </div>

  <script>
    function getBmiTag(height, weight) {
      const h = height / 100;
      const bmi = weight / (h * h);
      if (!isFinite(bmi)) return { bmi: null, label: "â€”" };

      if (bmi < 19) return { bmi, label: "åç˜¦ï¼ˆSlimï¼‰" };
      if (bmi < 25) return { bmi, label: "æ­£å¸¸ï¼ˆAverageï¼‰" };
      if (bmi < 30) return { bmi, label: "å¾®èƒ–ï¼ˆSlightly chubbyï¼‰" };
      return { bmi, label: "è±æ»¿ï¼ˆPlus-sizeï¼‰" };
    }

    function updateBmiDisplay() {
      const h = parseFloat(document.getElementById("height").value);
      const w = parseFloat(document.getElementById("weight").value);
      const el = document.getElementById("bmi-info");
      if (!h || !w) {
        el.textContent = "BMIï¼š--ï¼Œèº«å‹ï¼š--";
        return;
      }
      const { bmi, label } = getBmiTag(h, w);
      if (!bmi) {
        el.textContent = "BMIï¼š--ï¼Œèº«å‹ï¼š--";
        return;
      }
      el.textContent = `BMIï¼šç´„ ${bmi.toFixed(1)}ï¼Œèº«å‹æ¨ä¼°ï¼š${label}`;
    }

    document.getElementById("height").addEventListener("input", updateBmiDisplay);
    document.getElementById("weight").addEventListener("input", updateBmiDisplay);
    updateBmiDisplay();

    async function generateOutfit() {
      const gender = document.getElementById("gender").value;
      const age = parseInt(document.getElementById("age").value, 10);
      const style = document.getElementById("style").value;
      const temp = parseFloat(document.getElementById("temp").value);
      const height = parseFloat(document.getElementById("height").value);
      const weight = parseFloat(document.getElementById("weight").value);
      const withBag = document.getElementById("acc-bag").checked;
      const withHat = document.getElementById("acc-hat").checked;
      const withCoat = document.getElementById("acc-coat").checked;

      const status = document.getElementById("status");
      const btn = document.getElementById("generate-btn");
      const img = document.getElementById("result-image");
      const placeholder = document.getElementById("image-placeholder");

      if (!height || !weight || !age) {
        status.textContent = "è«‹å…ˆè¼¸å…¥å®Œæ•´çš„å¹´é½¡ã€èº«é«˜èˆ‡é«”é‡ã€‚";
        status.className = "status-text error";
        return;
      }

      status.textContent = "æ­£åœ¨ç”¢ç”Ÿ AI èº«æï¼‹ç©¿æ­ï¼‹é…ä»¶ç¤ºæ„åœ–ï¼ˆå¾Œç«¯æœƒè·‘é›™éšæ®µç”Ÿæˆï¼‰â€¦";
      status.className = "status-text loading";
      btn.disabled = true;

      try {
        const response = await fetch("/api/generate-image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            gender,
            age,
            style,
            temp,
            height,
            weight,
            withBag,
            withHat,
            withCoat
          })
        });

        const rawText = await response.text();
        let data;
        try {
          data = JSON.parse(rawText);
        } catch {
          console.error("generate-image raw:", rawText);
          throw new Error("API å›å‚³é JSONï¼š" + rawText.slice(0, 120));
        }

        if (!response.ok) {
          console.error("generate-image error detail:", data);
          throw new Error("API å›æ‡‰å¤±æ•—ï¼š" + response.status + "ï¼" + (data.error || "unknown"));
        }

        if (!data.image) {
          throw new Error("API æ²’æœ‰å›å‚³åœ–ç‰‡è³‡æ–™");
        }

        img.src = "data:image/png;base64," + data.image;
        img.style.display = "block";
        placeholder.style.display = "none";

        status.textContent = "å·²å®Œæˆï¼Œæ¥è‘—å¯ä»¥æ¸¬è©¦ã€æŠ“é¡ä¼¼å•†å“ã€åŠŸèƒ½ã€‚";
        status.className = "status-text done";
      } catch (err) {
        console.error(err);
        status.textContent = "ç”¢ç”Ÿåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message;
        status.className = "status-text error";
      } finally {
        btn.disabled = false;
      }
    }

    // ===== å•†å“æœå°‹ï¼ˆSerpApiï¼‰ =====

    function buildTestItemsForSearch() {
      const gender = document.getElementById("gender").value;
      const style = document.getElementById("style").value;

      const genderText =
        gender === "female"
          ? "female"
          : gender === "male"
          ? "male"
          : "unisex";

      let styleText = "casual";
      if (style === "minimal") styleText = "minimalist";
      else if (style === "street") styleText = "streetwear";
      else if (style === "sporty") styleText = "sporty";
      else if (style === "smart") styleText = "smart casual";

      // å…ˆ hardcode ä¸‰å€‹éƒ¨ä½ï¼šä¸Šè¡£ / ä¸‹èº« / é‹å­
      return [
        {
          slot: "top",
          generic_name: "oversized cotton crew neck t-shirt",
          color: "white",
          style: styleText,
          gender: genderText
        },
        {
          slot: "bottom",
          generic_name: "straight leg jeans",
          color: "light blue",
          style: styleText,
          gender: genderText
        },
        {
          slot: "shoes",
          generic_name: "white low-top sneakers",
          color: "white",
          style: styleText,
          gender: "unisex"
        }
      ];
    }

    function renderProductResults(data) {
      const container = document.getElementById("product-results");
      const status = document.getElementById("product-status");
      container.innerHTML = "";

      if (!data || !Array.isArray(data.results) || data.results.length === 0) {
        status.textContent = "æ²’æœ‰å–å›ä»»ä½•å•†å“çµæœã€‚";
        return;
      }

      status.textContent =
        "ä»¥ä¸‹ç‚º /api/search-products é€é SerpApi å›å‚³çš„éƒ¨åˆ† Google Shopping å•†å“çµæœï¼ˆæ¯å€‹éƒ¨ä½æœ€å¤š 3 ç­†ï¼‰ï¼š";

      data.results.forEach((block) => {
        const slot = block.slot || "item";
        const query = block.query || "";

        const header = document.createElement("div");
        header.style.fontSize = "11px";
        header.style.color = "#777";
        header.style.marginTop = "4px";
        header.textContent = `éƒ¨ä½ï¼š${slot}ï¼ˆquery: ${query}ï¼‰`;
        container.appendChild(header);

        if (block.error) {
          const errEl = document.createElement("div");
          errEl.style.fontSize = "11px";
          errEl.style.color = "#c00";
          errEl.textContent = "éŒ¯èª¤ï¼š" + block.error;
          container.appendChild(errEl);
          return;
        }

        (block.items || []).forEach((p) => {
          const card = document.createElement("div");
          card.className = "product-card";

          const thumb = document.createElement("div");
          thumb.className = "product-thumb";

          if (p.thumbnail) {
            const img = document.createElement("img");
            img.src = p.thumbnail;
            thumb.appendChild(img);
          } else {
            thumb.textContent = "No image";
          }

          const main = document.createElement("div");
          main.className = "product-main";

          const title = document.createElement("div");
          title.className = "product-title";
          title.textContent = p.title || "(no title)";

          const meta = document.createElement("div");
          meta.className = "product-meta";
          meta.textContent = p.source || "";

          const price = document.createElement("div");
          price.className = "product-price";
          const priceText =
            p.price != null
              ? `${p.price} ${p.currency || ""}`.trim()
              : "åƒ¹æ ¼ä¸æ˜";
          price.textContent = priceText;

          const link = document.createElement("a");
          link.className = "product-link";
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.href = p.link || "#";
          link.textContent = p.link ? "å‰å¾€å•†å“é " : "ç„¡é€£çµ";

          main.appendChild(title);
          main.appendChild(meta);
          main.appendChild(price);
          main.appendChild(link);

          card.appendChild(thumb);
          card.appendChild(main);

          container.appendChild(card);
        });
      });
    }

    async function searchSimilarProducts() {
      const status = document.getElementById("product-status");
      const container = document.getElementById("product-results");
      container.innerHTML = "";
      status.textContent = "æ­£åœ¨å‘¼å« /api/search-products ä¸¦é€é SerpApi æœå°‹å•†å“â€¦";

      try {
        const items = buildTestItemsForSearch();

        const resp = await fetch("/api/search-products", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items })
        });

        const text = await resp.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          console.error("search-products raw:", text);
          throw new Error("å¾Œç«¯å›å‚³é JSONï¼š" + text.slice(0, 120));
        }

        if (!resp.ok) {
          console.error("search-products error detail:", data);
          throw new Error(
            "API å›æ‡‰å¤±æ•—ï¼š" + resp.status + "ï¼" + (data.error || "unknown")
          );
        }

        console.log("search-products data:", data);
        renderProductResults(data);
      } catch (err) {
        console.error(err);
        status.textContent = "æœå°‹å•†å“æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message;
      }
    }
  </script>
</body>
</html>
